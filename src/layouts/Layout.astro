---
import "@fontsource/roboto/400.css";
import "@fontsource/roboto/500.css";
import "@fontsource/roboto/700.css";

import ConfigCarrier from "@components/ConfigCarrier.astro";
import CookieConsent from "@components/widget/CookieConsent.svelte";
import SurveyNotice from "@components/widget/SurveyNotice.svelte";
import { profileConfig, siteConfig } from "@/config";
import {
	AUTO_MODE,
	BANNER_HEIGHT,
	BANNER_HEIGHT_EXTEND,
	BANNER_HEIGHT_HOME,
	DARK_MODE,
	DEFAULT_THEME,
	LIGHT_MODE,
	PAGE_WIDTH,
} from "../constants/constants";
import { defaultFavicons } from "../constants/icon";
import type { Favicon } from "../types/config";
import { pathsEqual, url } from "../utils/url-utils";
import "katex/dist/katex.css";

interface Props {
	title?: string;
	banner?: string;
	description?: string;
	lang?: string;
	setOGTypeArticle?: boolean;
}

let { title, banner, description, lang, setOGTypeArticle } = Astro.props;

// apply a class to the body element to decide the height of the banner, only used for initial page load
// Swup can update the body for each page visit, but it's after the page transition, causing a delay for banner height change
// so use Swup hooks instead to change the height immediately when a link is clicked
const isHomePage = pathsEqual(Astro.url.pathname, url("/"));

// defines global css variables
// why doing this in Layout instead of GlobalStyles: https://github.com/withastro/astro/issues/6728#issuecomment-1502203757
const configHue = siteConfig.themeColor.hue;
if (!banner || typeof banner !== "string" || banner.trim() === "") {
	banner = siteConfig.banner.src;
}

// TODO don't use post cover as banner for now
banner = siteConfig.banner.src;

const enableBanner = siteConfig.banner.enable;

let pageTitle: string;
if (title) {
	pageTitle = `${title} - ${siteConfig.title}`;
} else {
	pageTitle = `${siteConfig.title} - ${siteConfig.subtitle}`;
}

const favicons: Favicon[] =
	siteConfig.favicon.length > 0 ? siteConfig.favicon : defaultFavicons;

// const siteLang = siteConfig.lang.replace('_', '-')
if (!lang) {
	lang = `${siteConfig.lang}`;
}
const siteLang = lang.replace("_", "-");

const bannerOffsetByPosition = {
	top: `${BANNER_HEIGHT_EXTEND}vh`,
	center: `${BANNER_HEIGHT_EXTEND / 2}vh`,
	bottom: "0",
};
const bannerOffset =
	bannerOffsetByPosition[siteConfig.banner.position || "center"];
---

<!DOCTYPE html>
<html lang={siteLang} class="bg-[var(--page-bg)] transition text-[14px] md:text-[16px]"
	  data-overlayscrollbars-initialize
>
	<head>

		<!-- Google tag (gtag.js) -->
		<script is:inline async src="https://www.googletagmanager.com/gtag/js?id=G-P698P6QFM4"></script>
		<script is:inline>
			window.dataLayer = window.dataLayer || [];
			function gtag() {
				window.dataLayer.push(arguments);
			}
			gtag('js', new Date());

			gtag('config', 'G-P698P6QFM4');
		</script>

		<!-- Google Ads Auto Ads -->
		<script is:inline async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7997781627133940" crossorigin="anonymous"></script>

		<!-- IndexNow -->
		<meta name="IndexNow" content="f5a35d993d654a85b9305b92b380c7f1" />

		<title>{pageTitle}</title>

		<meta charset="UTF-8" />
		<meta name="google-adsense-account" content="ca-pub-7997781627133940">
		<meta name="description" content={description || pageTitle}>
		<meta name="author" content={profileConfig.name}>

		<meta property="og:site_name" content={siteConfig.title}>
		<meta property="og:url" content={Astro.url}>
		<meta property="og:title" content={pageTitle}>
		<meta property="og:description" content={description || pageTitle}>
		{setOGTypeArticle ? (
        <meta property="og:type" content="article" />
        ) : (
        <meta property="og:type" content="website" />
        )}

		<meta name="twitter:card" content="summary_large_image">
		<meta property="twitter:url" content={Astro.url}>
		<meta name="twitter:title" content={pageTitle}>
		<meta name="twitter:description" content={description || pageTitle}>

		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		{favicons.map(favicon => (
			<link rel="icon"
				  href={favicon.src.startsWith('/') ? url(favicon.src) : favicon.src}
				  sizes={favicon.sizes}
				  media={favicon.theme && `(prefers-color-scheme: ${favicon.theme})`}
			/>
		))}

		<!-- Set the theme before the page is rendered to avoid a flash -->
		<script is:inline define:vars={{DEFAULT_THEME, LIGHT_MODE, DARK_MODE, AUTO_MODE, BANNER_HEIGHT_EXTEND, PAGE_WIDTH, configHue}}>
			// 域名访问警告功能
			function checkDomain() {
				// 获取当前域名
				const currentDomain = window.location.hostname;
				
				// 本地域名列表
				const localDomains = [
					'localhost',
					'127.0.0.1',
					/^192\.168\.\d+\.\d+$/,
					/^10\.\d+\.\d+\.\d+$/,
					/^172\.(1[6-9]|2[0-9]|3[0-1])\.\d+\.\d+$/,
					/^169\.254\.\d+\.\d+$/,
					'::1'
				];
				
				// 官方域名列表（及其子域）
				const officialDomains = [
					/^tncrr\.us\.kg$/,
					/^.*\.tncrr\.us\.kg$/,
					/^fornext\.asia$/,
					/^.*\.fornext\.asia$/,
					/^frnext\.qzz\.io$/,
					/^.*\.frnext\.qzz\.io$/,
					/^fuwari-t\.vercel\.app$/
				];
				
				// 检查是否为本地域名
				for (const domain of localDomains) {
					if (typeof domain === 'string') {
						if (currentDomain === domain) {
							return true;
						}
					} else if (domain instanceof RegExp) {
						if (domain.test(currentDomain)) {
							return true;
						}
					}
				}
				
				// 检查是否为官方域名
				for (const domain of officialDomains) {
					if (domain.test(currentDomain)) {
						return true;
					}
				}
				
				return false;
			}
			
			// 显示域名警告
			function showDomainWarning() {
				if (!checkDomain()) {
					const message = '您所访问的域名不是我们的官方网页，请确保网站安全再继续访问。点按确认将跳转到我们的官方网页，点按取消继续访问此网站';
					const shouldRedirect = confirm(message);
					
					if (shouldRedirect) {
						// 跳转到官方网页（使用主要官方域名）
						window.location.href = 'https://blog.tncrr.us.kg';
					}
				}
			}
			
			// 执行域名检查
			showDomainWarning();
			
			// Load the theme from local storage
			const theme = localStorage.getItem('theme') || DEFAULT_THEME;
			switch (theme) {
				case LIGHT_MODE:
					document.documentElement.classList.remove('dark');
					break
				case DARK_MODE:
					document.documentElement.classList.add('dark');
					break
				case AUTO_MODE:
					if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
						document.documentElement.classList.add('dark');
					} else {
						document.documentElement.classList.remove('dark');
					}
			}

			// Load the hue from local storage
			const hue = localStorage.getItem('hue') || configHue;
			document.documentElement.style.setProperty('--hue', hue);

			// calculate the --banner-height-extend, which needs to be a multiple of 4 to avoid blurry text
			let offset = Math.floor(window.innerHeight * (BANNER_HEIGHT_EXTEND / 100));
			offset = offset - offset % 4;
			document.documentElement.style.setProperty('--banner-height-extend', `${offset}px`);
		</script>
		<style define:vars={{
			configHue,
			'page-width': `${PAGE_WIDTH}rem`,
		}}></style>  <!-- defines global css variables. This will be applied to <html> <body> and some other elements idk why -->


		<slot name="head"></slot>

		<link rel="alternate" type="application/rss+xml" title={profileConfig.name} href={`${Astro.site}rss.xml`}/>
		


	</head>
	<body class=" min-h-screen transition " class:list={[{"lg:is-home": isHomePage, "enable-banner": enableBanner}]},
		  data-overlayscrollbars-initialize
	>


    <!-- Background image -->
    <img id="background-image" class="fixed inset-0 z-0 object-cover opacity-10 pointer-events-none" />
    
    <!-- Cookie consent banner -->
    <CookieConsent client:only="svelte"></CookieConsent>
    <SurveyNotice client:only="svelte"></SurveyNotice>		
		<!-- Floating Action Button for background controls -->
		<div id="fab-container" class="fixed bottom-4 right-4 z-50 cursor-move">
			<!-- Action buttons (hidden by default) -->
			<div id="fab-actions" class="flex flex-col items-end gap-2 mb-2 transition-all duration-300">
				<!-- Refresh background button -->
				<button id="random-background-btn" 
					class="bg-white/10 hover:bg-white/20 backdrop-blur-sm rounded-full p-3 text-white transition-all duration-300 shadow-lg hover:scale-110 active:scale-95 flex items-center gap-2 opacity-0 translate-y-4"
					aria-label="Refresh background image"
				>
					<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" />
						<path d="M21 3v5h-5" />
						<path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" />
						<path d="M3 21v-5h5" />
					</svg>
					<span class="text-sm">刷新背景</span>
				</button>
				
				<!-- Random visit background page button -->
				<button id="random-visit-btn" 
					class="bg-white/10 hover:bg-white/20 backdrop-blur-sm rounded-full p-3 text-white transition-all duration-300 shadow-lg hover:scale-110 active:scale-95 flex items-center gap-2 opacity-0 translate-y-4"
					aria-label="Random visit background page"
				>
					<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
						<rect x="7" y="7" width="3" height="3" />
						<rect x="14" y="7" width="3" height="3" />
						<rect x="7" y="14" width="3" height="3" />
						<rect x="14" y="14" width="3" height="3" />
					</svg>
					<span class="text-sm">随机访问背景页</span>
				</button>
				
				<!-- Copy background image URL button -->
				<button id="copy-bg-url-btn" 
					class="bg-white/10 hover:bg-white/20 backdrop-blur-sm rounded-full p-3 text-white transition-all duration-300 shadow-lg hover:scale-110 active:scale-95 flex items-center gap-2 opacity-0 translate-y-4 hidden md:flex"
					aria-label="Copy background image URL"
				>
					<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<rect x="9" y="9" width="13" height="13" rx="2" ry="2" />
						<path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
					</svg>
					<span class="text-sm">复制图片链接</span>
				</button>
			</div>
			
			<!-- Main FAB button -->
			<button id="fab-main" 
				class="bg-[var(--primary)] hover:bg-[var(--primary)]/90 rounded-full p-4 text-white transition-all duration-300 shadow-lg hover:scale-110 active:scale-95"
				aria-label="Background controls"
			>
				<svg id="fab-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="transition-transform duration-300">
					<circle cx="12" cy="12" r="3" />
					<path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
				</svg>
			</button>
		</div>
		
		<!-- Copy success notification -->
		<div id="copy-notification" class="fixed top-[20%] right-[-300px] z-50 bg-white/20 backdrop-blur-md rounded-l-lg p-4 text-white shadow-lg transition-all duration-300 ease-in-out">
			<div class="flex items-center gap-2">
				<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
					<path d="M20 6 9 17l-5-5" />
				</svg>
				<span>链接已复制</span>
			</div>
			<div id="notification-timer" class="absolute bottom-0 left-0 h-1 bg-white transition-all duration-3000 ease-out"></div>
		</div>
		
		<ConfigCarrier></ConfigCarrier>
		<slot />

		<!-- increase the page height during page transition to prevent the scrolling animation from jumping -->
		<div id="page-height-extend" class="hidden h-[300vh]"></div>
	</body>
</html>

<style is:global define:vars={{
	bannerOffset,
	'banner-height-home': `${BANNER_HEIGHT_HOME}vh`,
	'banner-height': `${BANNER_HEIGHT}vh`,
}}>
@tailwind components;
@layer components {
	.enable-banner.is-home #banner-wrapper {
		@apply h-[var(--banner-height-home)] translate-y-[var(--banner-height-extend)]
	}
	.enable-banner #banner-wrapper {
		@apply h-[var(--banner-height-home)]
	}

	.enable-banner.is-home #banner {
		@apply h-[var(--banner-height-home)] translate-y-0
	}
	.enable-banner #banner {
		@apply h-[var(--banner-height-home)] translate-y-[var(--bannerOffset)]
	}
	.enable-banner.is-home #main-grid {
		@apply translate-y-[var(--banner-height-extend)];
	}
	.enable-banner #top-row {
		@apply h-[calc(var(--banner-height-home)_-_4.5rem)] transition-all duration-300
	}
	.enable-banner.is-home #sidebar-sticky {
		@apply top-[calc(1rem_-_var(--banner-height-extend))]
	}
	.navbar-hidden {
		@apply opacity-0 -translate-y-16
	}
}

/* Background image styles */
#background-image {
	position: fixed;
	inset: 0;
	z-index: -1;
	width: 100%;
	height: 100%;
	object-fit: cover;
	opacity: 0.3;
	pointer-events: none;
}
</style>

<script>
// 扩展Window接口，添加toggleCookieConsent方法
declare global {
	interface Window {
		toggleCookieConsent: () => void;
	}
}

import 'overlayscrollbars/overlayscrollbars.css';
import {
	OverlayScrollbars,
	// ScrollbarsHidingPlugin,
	// SizeObserverPlugin,
	// ClickScrollPlugin
} from 'overlayscrollbars';
import {getHue, getStoredTheme, getBackgroundOpacity, getCardOpacity, setHue, setTheme, setBackgroundOpacity} from "../utils/setting-utils";
import {pathsEqual, url} from "../utils/url-utils";
import {
	BANNER_HEIGHT,
	BANNER_HEIGHT_HOME,
	BANNER_HEIGHT_EXTEND,
	MAIN_PANEL_OVERLAPS_BANNER_HEIGHT
} from "../constants/constants";
import { siteConfig } from '../config';

/* Preload fonts */
// (async function() {
// 	try {
// 		await Promise.all([
// 			document.fonts.load("400 1em Roboto"),
// 			document.fonts.load("700 1em Roboto"),
// 		]);
// 		document.body.classList.remove("hidden");
// 	} catch (error) {
// 		console.log("Failed to load fonts:", error);
// 	}
// })();

/* TODO This is a temporary solution for style flicker issue when the transition is activated */
/* issue link: https://github.com/withastro/astro/issues/8711, the solution get from here too */
/* update: fixed in Astro 3.2.4 */
/*
function disableAnimation() {
	const css = document.createElement('style')
	css.appendChild(
		document.createTextNode(
			`*{
              -webkit-transition:none!important;
              -moz-transition:none!important;
              -o-transition:none!important;
              -ms-transition:none!important;
              transition:none!important
              }`
		)
	)
	document.head.appendChild(css)

	return () => {
		// Force restyle
		;(() => window.getComputedStyle(document.body))()

		// Wait for next tick before removing
		setTimeout(() => {
			document.head.removeChild(css)
		}, 1)
	}
}
*/

const bannerEnabled = !!document.getElementById('banner-wrapper')

function setClickOutsideToClose(panel: string, ignores: string[]) {
	document.addEventListener("click", event => {
		let panelDom = document.getElementById(panel);
		let tDom = event.target;
		if (!(tDom instanceof Node)) return;		// Ensure the event target is an HTML Node
		for (let ig of ignores) {
			let ie = document.getElementById(ig)
			if (ie == tDom || (ie?.contains(tDom))) {
				return;
			}
		}
		panelDom!.classList.add("float-panel-closed");
	});
}
setClickOutsideToClose("display-setting", ["display-setting", "display-settings-switch"])
setClickOutsideToClose("nav-menu-panel", ["nav-menu-panel", "nav-menu-switch"])
setClickOutsideToClose("search-panel", ["search-panel", "search-bar", "search-switch"])


function loadTheme() {
	const theme = getStoredTheme()
	setTheme(theme)
}

function loadHue() {
	setHue(getHue())
}

function initCustomScrollbar() {
	const bodyElement = document.querySelector('body');
	if (!bodyElement) return;
	OverlayScrollbars(
		// docs say that a initialization to the body element would affect native functionality like window.scrollTo
		// but just leave it here for now
		{
			target: bodyElement,
			cancel: {
				nativeScrollbarsOverlaid: true,    // don't initialize the overlay scrollbar if there is a native one
			}
		}, {
		scrollbars: {
			theme: 'scrollbar-base scrollbar-auto py-1',
			autoHide: 'move',
			autoHideDelay: 500,
			autoHideSuspend: false,
		},
	});

	const katexElements = document.querySelectorAll('.katex-display') as NodeListOf<HTMLElement>;

	const katexObserverOptions = {
		root: null,
		rootMargin: '100px',
		threshold: 0.1
	};

	const processKatexElement = (element: HTMLElement) => {
		if (!element.parentNode) return;
		if (element.hasAttribute('data-scrollbar-initialized')) return;

		const container = document.createElement('div');
		container.className = 'katex-display-container';
		container.setAttribute('aria-label', 'scrollable container for formulas');

		element.parentNode.insertBefore(container, element);
		container.appendChild(element);

		OverlayScrollbars(container, {
			scrollbars: {
				theme: 'scrollbar-base scrollbar-auto',
				autoHide: 'leave',
				autoHideDelay: 500,
				autoHideSuspend: false
			}
		});

		element.setAttribute('data-scrollbar-initialized', 'true');
	};

	const katexObserver = new IntersectionObserver((entries, observer) => {
		entries.forEach(entry => {
			if (entry.isIntersecting) {
			processKatexElement(entry.target as HTMLElement);
			observer.unobserve(entry.target);
			}
		});
	}, katexObserverOptions);

	katexElements.forEach(element => {
		katexObserver.observe(element);
	});
}

function showBanner() {
	if (!siteConfig.banner.enable) return;

	const banner = document.getElementById('banner');
	if (!banner) {
		console.error('Banner element not found');
		return;
	}

	banner.classList.remove('opacity-0', 'scale-105');
}

function init() {
	// disableAnimation()()		// TODO
	loadTheme();
	loadHue();
	initCustomScrollbar();
	showBanner();
}

/* Load settings when entering the site */
init();

const setup = () => {
	// TODO: temp solution to change the height of the banner
/*
	window.swup.hooks.on('animation:out:start', () => {
		const path = window.location.pathname
		const body = document.querySelector('body')
		if (path[path.length - 1] === '/' && !body.classList.contains('is-home')) {
			body.classList.add('is-home')
		} else if (path[path.length - 1] !== '/' && body.classList.contains('is-home')) {
			body.classList.remove('is-home')
		}
	})
*/
	window.swup.hooks.on('link:click', () => {
		// Remove the delay for the first time page load
		document.documentElement.style.setProperty('--content-delay', '0ms')

		// prevent elements from overlapping the navbar
		if (!bannerEnabled) {
			return
		}
		let threshold = window.innerHeight * (BANNER_HEIGHT / 100) - 72 - 16
		let navbar = document.getElementById('navbar-wrapper')
		if (!navbar || !document.body.classList.contains('lg:is-home')) {
			return
		}
		if (document.body.scrollTop >= threshold || document.documentElement.scrollTop >= threshold) {
			navbar.classList.add('navbar-hidden')
		}
	})
	window.swup.hooks.on('content:replace', initCustomScrollbar)
	window.swup.hooks.on('visit:start', (visit: {to: {url: string}}) => {
		// change banner height immediately when a link is clicked
		const bodyElement = document.querySelector('body')
		if (pathsEqual(visit.to.url, url('/'))) {
			bodyElement!.classList.add('lg:is-home');
		} else {
			bodyElement!.classList.remove('lg:is-home');
		}

		// increase the page height during page transition to prevent the scrolling animation from jumping
		const heightExtend = document.getElementById('page-height-extend')
		if (heightExtend) {
			heightExtend.classList.remove('hidden')
		}

		// Hide the TOC while scrolling back to top
		let toc = document.getElementById('toc-wrapper');
		if (toc) {
			toc.classList.add('toc-not-ready')
		}
	});
	window.swup.hooks.on('page:view', () => {
		// hide the temp high element when the transition is done
		const heightExtend = document.getElementById('page-height-extend')
		if (heightExtend) {
			heightExtend.classList.remove('hidden')
		}
	});
	window.swup.hooks.on('visit:end', (_visit: {to: {url: string}}) => {
		setTimeout(() => {
			const heightExtend = document.getElementById('page-height-extend')
			if (heightExtend) {
				heightExtend.classList.add('hidden')
			}

            // Just make the transition looks better
            const toc = document.getElementById('toc-wrapper');
            if (toc) {
                toc.classList.remove('toc-not-ready')
            }
        }, 200)
	});
}
if (window?.swup?.hooks) {
	setup()
} else {
	document.addEventListener('swup:enable', setup)
}

let backToTopBtn = document.getElementById('back-to-top-btn');
let toc = document.getElementById('toc-wrapper');
let navbar = document.getElementById('navbar-wrapper')
function scrollFunction() {
	let bannerHeight = window.innerHeight * (BANNER_HEIGHT / 100)

	if (backToTopBtn) {
		if (document.body.scrollTop > bannerHeight || document.documentElement.scrollTop > bannerHeight) {
			backToTopBtn.classList.remove('hide')
		} else {
			backToTopBtn.classList.add('hide')
		}
	}

	if (bannerEnabled && toc) {
		if (document.body.scrollTop > bannerHeight || document.documentElement.scrollTop > bannerHeight) {
			toc.classList.remove('toc-hide')
		} else {
			toc.classList.add('toc-hide')
		}
	}

	if (!bannerEnabled) return
	if (navbar) {
		const NAVBAR_HEIGHT = 72
		const MAIN_PANEL_EXCESS_HEIGHT = MAIN_PANEL_OVERLAPS_BANNER_HEIGHT * 16			// The height the main panel overlaps the banner

		let bannerHeight = BANNER_HEIGHT
		if (document.body.classList.contains('lg:is-home') && window.innerWidth >= 1024) {
			bannerHeight = BANNER_HEIGHT_HOME
		}
		let threshold = window.innerHeight * (bannerHeight / 100) - NAVBAR_HEIGHT - MAIN_PANEL_EXCESS_HEIGHT - 16
		if (document.body.scrollTop >= threshold || document.documentElement.scrollTop >= threshold) {
			navbar.classList.add('navbar-hidden')
		} else {
			navbar.classList.remove('navbar-hidden')
		}
	}
}
window.onscroll = scrollFunction

window.onresize = () => {
	// calculate the --banner-height-extend, which needs to be a multiple of 4 to avoid blurry text
	let offset = Math.floor(window.innerHeight * (BANNER_HEIGHT_EXTEND / 100));
	offset = offset - offset % 4;
	document.documentElement.style.setProperty('--banner-height-extend', `${offset}px`);
}

// 定义背景图片URL列表和获取实际URL的函数
		const getBackgroundUrls = () => {
			const isMobile = window.innerWidth < 768; // 判断是否为移动端
			
			// 根据设备类型选择不同的图片列表
			return isMobile ? 
				// 移动端使用竖图
				[
					'https://t.alcy.cc/mp',      // 移动竖图
					'https://t.alcy.cc/moemp',   // 萌版竖图
					'https://t.alcy.cc/ysmp',    // 原神竖图
					'https://t.alcy.cc/ycy',     // 二次元自适应
					'https://t.alcy.cc/moez',    // 萌版自适应
					'https://t.alcy.cc/ai',      // ai自适应
					'https://t.alcy.cc/ysz'      // 原神自适应
				] : 
				// PC端使用横图
				[
					'https://t.alcy.cc/pc',      // PC横图
					'https://t.alcy.cc/ys',      // 原神横图
					'https://t.alcy.cc/fj',      // 风景横图
					'https://t.alcy.cc/ycy',     // 二次元自适应
					'https://t.alcy.cc/moez',    // 萌版自适应
					'https://t.alcy.cc/ai',      // ai自适应
					'https://t.alcy.cc/ysz'      // 原神自适应
				];
		};
		
		// 获取实际的重定向URL
		const getActualImageUrl = async (shortUrl: string): Promise<string> => {
			try {
				const response = await fetch(shortUrl, {
					method: 'HEAD',
					redirect: 'follow',
					mode: 'cors'
				});
				return response.url;
			} catch (error) {
				console.error('Error getting actual image URL:', error);
				// 如果获取失败，使用原始URL
				return shortUrl;
			}
		};
		
		// 设置背景图片
		const setBackgroundImage = async () => {
			const backgroundUrls = getBackgroundUrls();
			const randomIndex = Math.floor(Math.random() * backgroundUrls.length);
			const randomUrl = backgroundUrls[randomIndex];
			
			// 获取实际的重定向URL
			const actualImageUrl = await getActualImageUrl(randomUrl);
			console.log('Actual image URL:', actualImageUrl);
			
			// Set the background image
			const backgroundImage = document.getElementById('background-image') as HTMLImageElement;
			if (backgroundImage) {
				backgroundImage.src = randomUrl;
				// 存储实际的图片URL到元素的dataset中
				backgroundImage.dataset.actualUrl = actualImageUrl;
				// 直接设置不透明度为90%
				backgroundImage.style.opacity = '0.75';
				
				// 更新显示的背景图片URL
				const bgUrlValue = document.getElementById('bg-url-value');
				if (bgUrlValue) {
					bgUrlValue.textContent = actualImageUrl;
				}
			}
		};
		
		// 显示复制成功提示
		const showCopyNotification = () => {
			const notification = document.getElementById('copy-notification');
			const timerBar = document.getElementById('notification-timer');
			if (!notification || !timerBar) return;
			
			// 重置计时器宽度
			timerBar.style.width = '100%';
			
			// 显示通知
			notification.style.right = '0';
			
			// 3秒后隐藏通知
			setTimeout(() => {
				notification.style.right = '-300px';
			}, 3000);
		};
		
		// Set random background image on page load
		window.addEventListener('DOMContentLoaded', async () => {
			await setBackgroundImage();
			
			// 刷新背景按钮事件
				const randomBackgroundBtn = document.getElementById('random-background-btn') as HTMLButtonElement | null;
				if (randomBackgroundBtn) {
					randomBackgroundBtn.addEventListener('click', async () => {
						// 显示加载提示
						randomBackgroundBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg><span class="text-sm">刷新中...</span>';
						randomBackgroundBtn.disabled = true;
						
						try {
							await setBackgroundImage();
						} catch (error) {
							console.error('Error setting background image:', error);
							alert('设置背景图片失败，请稍后重试');
						} finally {
							// 恢复按钮状态
							randomBackgroundBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" /><path d="M21 3v5h-5" /><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" /><path d="M3 21v-5h5" /></svg><span class="text-sm">刷新背景</span>';
							randomBackgroundBtn.disabled = false;
						}
					});
					}
				
				// 随机访问背景页按钮事件
				const randomVisitBtn = document.getElementById('random-visit-btn');
				if (randomVisitBtn) {
					randomVisitBtn.addEventListener('click', () => {
						// 获取对应设备的背景链接列表
						const backgroundUrls = getBackgroundUrls();
						// 随机选择一个链接
						const randomIndex = Math.floor(Math.random() * backgroundUrls.length);
						const randomUrl = backgroundUrls[randomIndex];
						
						// 在新标签页中打开链接
						window.open(randomUrl, '_blank');
					});
				}
				
				// 复制背景图片URL事件
			const backgroundImageUrl = document.getElementById('background-image-url');
			if (backgroundImageUrl) {
				backgroundImageUrl.addEventListener('click', async () => {
					const backgroundImage = document.getElementById('background-image');
					if (!backgroundImage || !backgroundImage.dataset.actualUrl) {
						console.error('Background image URL not found');
						return;
					}
					
					try {
						// 复制URL到剪贴板
						await navigator.clipboard.writeText(backgroundImage.dataset.actualUrl);
						
						// 显示复制成功提示
						showCopyNotification();
					} catch (error) {
						console.error('Error copying URL:', error);
						alert('复制链接失败，请稍后重试');
					}
				});
			}

			// 初始化FAB功能
			function initFAB() {
				const fabContainer = document.getElementById('fab-container');
				const fabMain = document.getElementById('fab-main');
				const fabActions = document.getElementById('fab-actions');
				const fabIcon = document.getElementById('fab-icon');
				
				// 空值检查
				if (!fabContainer || !fabMain || !fabActions || !fabIcon) {
					return;
				}
				
				const actionButtons = fabActions.querySelectorAll('button');
				
				let isExpanded = false;
				let isDragging = false;
				let startX: number = 0;
				let startY: number = 0;
				let offsetX: number = 0;
				let offsetY: number = 0;
				
				// 切换FAB展开/收起状态
				fabMain.addEventListener('click', function (e) {
					e.stopPropagation();
					isExpanded = !isExpanded;
					
					// 切换主按钮图标
					fabIcon.style.transform = isExpanded ? 'rotate(45deg)' : 'rotate(0deg)';
					
					// 显示/隐藏操作按钮
					actionButtons.forEach((btn, index) => {
						setTimeout(() => {
							if (isExpanded) {
								btn.style.opacity = '1';
								btn.style.transform = 'translateY(0)';
							} else {
								btn.style.opacity = '0';
								btn.style.transform = 'translateY(10px)';
							}
						}, index * 50);
					});
				});
				
				// 点击页面其他地方收起FAB
				document.addEventListener('click', function () {
					if (isExpanded) {
						isExpanded = false;
						fabIcon.style.transform = 'rotate(0deg)';
						actionButtons.forEach(btn => {
							btn.style.opacity = '0';
							btn.style.transform = 'translateY(10px)';
						});
					}
				});
				
				// 阻止FAB内部点击事件冒泡
				fabActions.addEventListener('click', function (e) {
					e.stopPropagation();
				});
				
				// 实现FAB移动功能
				fabContainer.addEventListener('mousedown', function (e) {
					const target = e.target as Node;
					if (e.target === fabMain || fabMain.contains(target)) {
						return; // 点击主按钮时不移动
					}
					
					isDragging = true;
					startX = e.clientX;
					startY = e.clientY;
					
					// 获取FAB当前位置
					const rect = fabContainer.getBoundingClientRect();
					offsetX = rect.left;
					offsetY = rect.top;
					
					fabContainer.style.cursor = 'grabbing';
				});
				
				document.addEventListener('mousemove', function (e) {
					if (isDragging) {
						const dx = e.clientX - startX;
						const dy = e.clientY - startY;
						
						// 计算新位置
						let newX = offsetX + dx;
						let newY = offsetY + dy;
						
						// 限制在视口内
						const fabWidth = fabContainer.offsetWidth;
						const fabHeight = fabContainer.offsetHeight;
						const viewportWidth = window.innerWidth;
						const viewportHeight = window.innerHeight;
						
						newX = Math.max(0, Math.min(newX, viewportWidth - fabWidth));
						newY = Math.max(0, Math.min(newY, viewportHeight - fabHeight));
						
						// 更新位置
						fabContainer.style.left = `${newX}px`;
						fabContainer.style.top = `${newY}px`;
						fabContainer.style.bottom = 'auto';
						fabContainer.style.right = 'auto';
					}
				});
				
				document.addEventListener('mouseup', function () {
					isDragging = false;
					fabContainer.style.cursor = 'move';
				});
				
				// 为复制图片链接按钮添加事件
				const copyBgUrlBtn = document.getElementById('copy-bg-url-btn');
				if (copyBgUrlBtn) {
					copyBgUrlBtn.addEventListener('click', async () => {
						const backgroundImage = document.getElementById('background-image');
						if (!backgroundImage || !backgroundImage.dataset.actualUrl) {
							console.error('Background image URL not found');
							return;
						}
						
						try {
							// 复制URL到剪贴板
							await navigator.clipboard.writeText(backgroundImage.dataset.actualUrl);
							
							// 显示复制成功提示
							showCopyNotification();
						} catch (error) {
							console.error('Error copying URL:', error);
							alert('复制链接失败，请稍后重试');
						}
					});
				}
			}
			
			// 初始化FAB
			initFAB();

		});

		// 节假日数据 (2026年)
		const holidays = [
			{ date: '2026-01-01', name: '元旦', greeting: '2026新年快乐', priority: 10 },
			{ date: '2026-02-17', name: '春节', greeting: '中国农历春节快乐', priority: 10 },
			{ date: '2026-04-05', name: '清明节', greeting: '清明安康', priority: 9 },
			{ date: '2026-05-01', name: '劳动节', greeting: '劳动节快乐', priority: 9 },
			{ date: '2026-06-21', name: '端午节', greeting: '端午安康', priority: 9 },
			{ date: '2026-09-27', name: '中秋节', greeting: '中秋快乐', priority: 9 },
			{ date: '2026-10-01', name: '国庆节', greeting: '国庆快乐', priority: 10 }
		];

		// 24节气数据 (2026年精确日期)
		const solarTerms = [
			{ date: '2026-01-06', name: '小寒', saying: '小寒料峭，一番春意换年芳' },
			{ date: '2026-01-20', name: '大寒', saying: '大寒岁底庆团圆' },
			{ date: '2026-02-04', name: '立春', saying: '立春阳气转，大地渐回暖' },
			{ date: '2026-02-19', name: '雨水', saying: '雨水润万物，春意满人间' },
			{ date: '2026-03-05', name: '惊蛰', saying: '惊蛰春雷响，万物长生机' },
			{ date: '2026-03-20', name: '春分', saying: '春分昼夜均，花开满枝头' },
			{ date: '2026-04-05', name: '清明', saying: '清明时节雨纷纷，路上行人欲断魂' },
			{ date: '2026-04-20', name: '谷雨', saying: '谷雨生百谷，万物正逢时' },
			{ date: '2026-05-05', name: '立夏', saying: '立夏万物长，天地始交泰' },
			{ date: '2026-05-21', name: '小满', saying: '小满麦粒满，丰收在眼前' },
			{ date: '2026-06-06', name: '芒种', saying: '芒种忙种，不误农时' },
			{ date: '2026-06-21', name: '夏至', saying: '夏至日长至，阳极阴生时' },
			{ date: '2026-07-07', name: '小暑', saying: '小暑不算热，大暑三伏天' },
			{ date: '2026-07-23', name: '大暑', saying: '大暑热难当，心静自然凉' },
			{ date: '2026-08-07', name: '立秋', saying: '立秋凉风至，一叶知秋意' },
			{ date: '2026-08-23', name: '处暑', saying: '处暑天渐凉，丰收满粮仓' },
			{ date: '2026-09-07', name: '白露', saying: '白露秋分夜，一夜凉一夜' },
			{ date: '2026-09-23', name: '秋分', saying: '秋分昼夜平，平分秋色时' },
			{ date: '2026-10-08', name: '寒露', saying: '寒露惊秋晚，朝看菊渐黄' },
			{ date: '2026-10-23', name: '霜降', saying: '霜降露成霜，木叶尽脱时' },
			{ date: '2026-11-07', name: '立冬', saying: '立冬万物藏，天地始闭藏' },
			{ date: '2026-11-22', name: '小雪', saying: '小雪雪初降，天地渐苍茫' },
			{ date: '2026-12-07', name: '大雪', saying: '大雪雪纷飞，瑞雪兆丰年' },
			{ date: '2026-12-21', name: '冬至', saying: '冬至阳生，数九寒天始' }
		];

		// 格式化日期为YYYY-MM-DD
		function formatDate(date: Date) {
			const year = date.getFullYear();
			const month = String(date.getMonth() + 1).padStart(2, '0');
			const day = String(date.getDate()).padStart(2, '0');
			return `${year}-${month}-${day}`;
		}

		// 检查今天是否是节假日
		function isTodayHoliday(now: Date) {
			const todayStr = formatDate(now);
			return holidays.find(holiday => holiday.date === todayStr);
		}

		// 检查今天是否是节气
		function isTodaySolarTerm(now: Date) {
			const todayStr = formatDate(now);
			return solarTerms.find(term => term.date === todayStr);
		}

		// 添加自适应高对比度样式
		function addHighContrastStyle() {
			const banner = document.getElementById('countdown-banner');
			if (!banner) return;

			// 确保横幅背景始终为纯白色
			banner.style.backgroundColor = 'white';
			banner.style.backgroundImage = 'none';

			const titleSpan = banner.querySelector('span:first-child');
			const countdownSpan = banner.querySelector('#countdown-text');
			const lastUpdateSpan = banner.querySelector('#last-update-time');
			if (titleSpan && countdownSpan) {
				// 确保文本使用固定的颜色方案
				const titleElement = titleSpan as HTMLElement;
				const countdownElement = countdownSpan as HTMLElement;
				const lastUpdateElement = lastUpdateSpan as HTMLElement;
				
				// 固定颜色：普通文字黑色，时间文字蓝色
				titleElement.style.color = 'black';
				titleElement.style.textShadow = 'none';
				countdownElement.style.color = 'blue-600';
				countdownElement.style.textShadow = 'none';
				if (lastUpdateElement) {
					lastUpdateElement.style.color = 'blue-600';
					lastUpdateElement.style.textShadow = 'none';
				}
			}
		}

		// 获取下一个节假日
		function getNextHoliday(now: Date) {
			const todayStr = formatDate(now);
			const filteredHolidays = holidays.filter(holiday => holiday.date > todayStr);
			if (filteredHolidays.length === 0) {
				// 如果今年的节假日都过了，返回明年的第一个节假日
				return { ...holidays[0], date: `${now.getFullYear() + 1}-01-01`, name: '元旦', greeting: `${now.getFullYear() + 1}新年快乐` };
			}
			return filteredHolidays[0];
		}

		// 计算剩余时间
		function calculateTimeRemaining(targetDate: Date, now: Date) {
			const timeRemaining = targetDate.getTime() - now.getTime();
			const days = Math.floor(timeRemaining / (1000 * 60 * 60 * 24));
			const hours = Math.floor((timeRemaining % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
			const minutes = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
			const seconds = Math.floor((timeRemaining % (1000 * 60)) / 1000);
			return { days, hours, minutes, seconds };
		}

		// 更新倒计时横幅
		// 可选参数testDate用于测试不同日期，格式为YYYY-MM-DD
		function updateCountdown(testDate = null) {
			const now = testDate ? new Date(testDate + 'T12:00:00') : new Date();
			const bannerTitle = document.querySelector('#countdown-banner span:first-child');
			const countdownText = document.getElementById('countdown-text');

			if (!bannerTitle || !countdownText) return;

			// 检查今天是否是节假日
			const todayHoliday = isTodayHoliday(now);
			if (todayHoliday) {
				// 今天是节假日，显示祝福语
				bannerTitle.textContent = '';
				countdownText.textContent = todayHoliday.greeting;
				return;
			}

			// 检查今天是否是节气
			const todaySolarTerm = isTodaySolarTerm(now);
			if (todaySolarTerm) {
				// 今天是节气，显示节气名称和句子
				bannerTitle.textContent = `${todaySolarTerm.name}：`;
				countdownText.textContent = todaySolarTerm.saying;
				return;
			}

			// 否则，显示下一个节假日的倒计时
			const nextHoliday = getNextHoliday(now);
			const targetDate = new Date(nextHoliday.date + 'T00:00:00');
			const timeRemaining = calculateTimeRemaining(targetDate, now);

			bannerTitle.textContent = `距离${nextHoliday.name}还有：`;
			countdownText.textContent = `${timeRemaining.days}天${timeRemaining.hours}小时${timeRemaining.minutes}分钟${timeRemaining.seconds}秒`;
		}

		// 横幅收起功能
		function initBannerCollapse() {
			const banner = document.getElementById('countdown-banner') as HTMLElement | null;
			const btn = document.getElementById('banner-collapse-btn') as HTMLElement | null;
			const navbarWrapper = document.getElementById('navbar-wrapper') as HTMLElement | null;
			
			if (!banner || !btn || !navbarWrapper) return;

			// 初始状态：展开横幅
			expandBanner();

			// 点击事件
			btn.addEventListener('click', () => {
				const isCurrentlyCollapsed = banner.classList.contains('collapsed');
				if (isCurrentlyCollapsed) {
					expandBanner();
				} else {
					collapseBanner();
				}
			});

			// 移动端检测：屏幕宽度小于768px
			const isMobile = window.innerWidth < 768;
			
			// 如果是移动端，10秒后自动收起横幅
			if (isMobile) {
				setTimeout(() => {
					if (!banner.classList.contains('collapsed')) {
						collapseBanner();
					}
				}, 10000); // 10秒
			}

			function collapseBanner() {
				if (banner && navbarWrapper && btn) {
					banner.classList.add('collapsed');
					banner.style.height = '0';
					banner.style.padding = '0';
					banner.style.overflow = 'hidden';
					banner.style.opacity = '0';
					// 移除边框
					banner.style.borderBottom = 'none';
					// 更新顶栏位置
					navbarWrapper.style.top = '0';
					// 更新按钮图标
					btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>';
				}
			}

			function expandBanner() {
				if (banner && navbarWrapper && btn) {
					banner.classList.remove('collapsed');
					banner.style.height = 'auto';
					banner.style.padding = '';
					banner.style.overflow = '';
					banner.style.opacity = '';
					// 恢复边框
					banner.style.borderBottom = '';
					// 更新顶栏位置
					navbarWrapper.style.top = '2.5rem';
					// 更新按钮图标
					btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 15-6-6-6 6"/></svg>';
				}
			}
		}

		// 初始化背景透明度
		const initBackgroundOpacity = () => {
			const opacity = getBackgroundOpacity();
			const backgroundImage = document.getElementById("background-image");
			if (backgroundImage) {
				backgroundImage.style.opacity = String(opacity);
			}
		};

		// 初始化卡片背景透明度
		const initCardOpacity = () => {
			const opacity = getCardOpacity();
			const root = document.querySelector(":root") as HTMLElement;
			if (!root) {
				return;
			}
			// 获取当前主题模式
			const isDarkMode = document.documentElement.classList.contains("dark");
			// 设置卡片背景透明度
			if (isDarkMode) {
				root.style.setProperty("--card-bg", `rgba(37, 37, 42, ${opacity})`);
			} else {
				root.style.setProperty("--card-bg", `rgba(255, 255, 255, ${opacity})`);
			}
		};



		// 初始化样式
		initBackgroundOpacity();
		initCardOpacity();
		
		// 添加全局toggleCookieConsent函数，用于从顶栏按钮调用
		window.toggleCookieConsent = function() {
			// 触发自定义事件，通知CookieConsent组件切换显示状态
			document.dispatchEvent(new CustomEvent('toggleCookieConsent'));
		};

</script>

<script>
import PhotoSwipeLightbox from "photoswipe/lightbox"
import "photoswipe/style.css"

let lightbox: PhotoSwipeLightbox
let pswp = import("photoswipe")

function createPhotoSwipe() {
	lightbox = new PhotoSwipeLightbox({
		gallery: ".custom-md img, #post-cover img",
		pswpModule: () => pswp,
		closeSVG: '<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#ffffff"><path d="M480-424 284-228q-11 11-28 11t-28-11q-11-11-11-28t11-28l196-196-196-196q-11-11-11-28t11-28q11-11 28-11t28 11l196 196 196-196q11-11 28-11t28 11q11 11 11 28t-11 28L536-480l196 196q11 11 11 28t-11 28q-11 11-28 11t-28-11L480-424Z"/></svg>',
		zoomSVG: '<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#ffffff"><path d="M340-540h-40q-17 0-28.5-11.5T260-580q0-17 11.5-28.5T300-620h40v-40q0-17 11.5-28.5T380-700q17 0 28.5 11.5T420-660v40h40q17 0 28.5 11.5T500-580q0 17-11.5 28.5T460-540h-40v40q0 17-11.5 28.5T380-460q-17 0-28.5-11.5T340-500v-40Zm40 220q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l224 224q11 11 11 28t-11 28q-11 11-28 11t-28-11L532-372q-30 24-69 38t-83 14Zm0-80q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/></svg>',
		padding: { top: 20, bottom: 20, left: 20, right: 20 },
		wheelToZoom: true,
		arrowPrev: false,
		arrowNext: false,
		imageClickAction: 'close',
		tapAction: 'close',
		doubleTapAction: 'zoom',
	})

	lightbox.addFilter("domItemData", (itemData, element) => {
		if (element instanceof HTMLImageElement) {
			itemData.src = element.src

			itemData.w = Number(element.naturalWidth || window.innerWidth)
			itemData.h = Number(element.naturalHeight || window.innerHeight)

			itemData.msrc = element.src
		}

		return itemData
	})

	lightbox.init()
}

const setup = () => {
	if (!lightbox) {
		createPhotoSwipe()
	}
	window.swup.hooks.on("page:view", () => {
		createPhotoSwipe()
	})

	window.swup.hooks.on(
		"content:replace",
		() => {
			lightbox?.destroy?.()
		},
		{ before: true },
	)
}

if (window.swup) {
	setup()
} else {
	document.addEventListener("swup:enable", setup)
}
</script>
